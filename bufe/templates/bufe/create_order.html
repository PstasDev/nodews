{% extends 'bufe/base.html' %}

{% block title %}√öj rendel√©s - B√ºf√©{% endblock %}
{% block meta_description %}√öj rendel√©s lead√°sa{% endblock %}
{% block nav_create_active %}active{% endblock %}

{% block extra_styles %}
<style>
    @media (min-width: 1024px) {
        .order-grid { grid-template-columns: 2fr 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Rendk√≠v√ºli z√°rva Alert -->
{% if bufe and bufe.rendkivuli_zarva %}
<div class="card mb-lg" style="border: 3px solid #dc3545;">
    <div class="card-body text-center" style="background-color: #f8d7da;">
        <h1 style="color: #721c24; margin-bottom: 1rem;">üö´ A b√ºf√© rendk√≠v√ºli okok miatt z√°rva tart</h1>
        <p style="color: #721c24; font-size: 1.2rem; margin-bottom: 1.5rem;">
            Jelenleg nem fogadunk el rendel√©seket. K√©rj√ºk, n√©zzen vissza k√©s≈ëbb.
        </p>
        {% if user.is_authenticated %}
            {% load bufe_extras %}
            {% if user|is_bufeadmin %}
            <a href="{% url 'bufe:admin_dashboard' %}" class="btn btn-lg" style="background-color: #721c24; color: white;">
                üîß Admin fel√ºlet megnyit√°sa
            </a>
            {% endif %}
        {% endif %}
        <br><br>
        <a href="{% url 'bufe:index' %}" class="btn btn-outline">‚Üê Vissza a f≈ëoldalra</a>
    </div>
</div>
{% else %}
<div class="card mb-lg">
    <div class="card-body">
        <h1>üõí √öj rendel√©s lead√°sa</h1>
        <p class="text-muted">V√°lassza ki a k√≠v√°nt term√©keket</p>
    </div>
</div>

{% if not is_open %}
<div class="alert alert-warning">
    <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
    <div><strong>Figyelem!</strong> A b√ºf√© jelenleg z√°rva van.</div>
</div>
{% endif %}

{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }}">{{ message }}</div>
{% endfor %}
{% endif %}

<form method="post" id="orderForm">
    {% csrf_token %}
    <div class="order-grid" style="display: grid; gap: var(--space-lg);">
        <div>
            {% if termekek_by_kategoria %}
            {% for kategoria, termekek in termekek_by_kategoria.items %}
            <div class="card mb-lg">
                <div class="card-header"><h3 style="margin:0;">{{ kategoria.nev }}</h3></div>
                <div class="card-body">
                    <div class="grid grid-2">
                        {% for termek in termekek %}
                        <div class="product-card">
                            <div class="product-name">{{ termek.nev }}</div>
                            <div class="product-price">{{ termek.ar }} Ft</div>
                            {% if termek.leiras %}<div class="product-description">{{ termek.leiras }}</div>{% endif %}
                            <div style="display: flex; gap: var(--space-xs); flex-wrap: wrap; margin-bottom: var(--space-md);">
                                {% if termek.hutve %}<span class="badge badge-info">‚ùÑÔ∏è H≈±tve</span>{% endif %}
                                {% if termek.kisult %}<span class="badge badge-warning">‚ö†Ô∏è Kis√ºlt</span>{% endif %}
                                <span class="badge badge-gray">Max {{ termek.max_rendelesenkent }} db</span>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" for="quantity_{{ termek.id }}">Mennyis√©g</label>
                                <input type="number" name="quantity_{{ termek.id }}" id="quantity_{{ termek.id }}" class="form-control quantity-input" min="0" max="{{ termek.max_rendelesenkent }}" value="0" data-price="{{ termek.ar }}" data-name="{{ termek.nev }}">
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}

            <div class="card">
                <div class="card-header"><h3 style="margin:0;">üìù Rendel√©s r√©szletei</h3></div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.szunet_valasztas.id_for_label }}">{{ form.szunet_valasztas.label }}</label>
                        {{ form.szunet_valasztas }}
                        {% if form.szunet_valasztas.help_text %}
                        <small class="text-muted">{{ form.szunet_valasztas.help_text }}</small>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="{{ form.idozitve.id_for_label }}">{{ form.idozitve.label }} <span style="color: var(--danger);">*</span></label>
                        <div style="display: flex; gap: var(--space-sm);">
                            {{ form.idozitve }}
                            <button type="button" class="btn btn-secondary" id="todayButton" title="Mai d√°tum kit√∂lt√©se">üìÖ Ma</button>
                        </div>
                        <small class="text-muted">Legal√°bb 10 perccel a jelenlegi id≈ëpont ut√°n kell lennie</small>
                        <div id="openingHoursWarning" style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: var(--warning); border-radius: var(--border-radius); color: #000;">
                            ‚ö†Ô∏è A kiv√°lasztott id≈ëpont a b√ºf√© nyitvatart√°si idej√©n k√≠v√ºl esik!
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" for="{{ form.megjegyzes.id_for_label }}">{{ form.megjegyzes.label }}</label>
                        {{ form.megjegyzes }}
                    </div>
                    {% if form.errors %}
                    <div class="alert alert-error mt-md">
                        {% for field, errors in form.errors.items %}
                        {% for error in errors %}<p>{{ error }}</p>{% endfor %}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="card">
                <div class="card-body text-center">
                    <h3>Jelenleg nincsenek el√©rhet≈ë term√©kek</h3>
                    <p class="text-muted">K√©rj√ºk, pr√≥b√°lja √∫jra k√©s≈ëbb.</p>
                </div>
            </div>
            {% endif %}
        </div>

        {% if termekek_by_kategoria %}
        <div>
            <div class="card" style="position: sticky; top: calc(var(--space-md) + 60px);">
                <div class="card-header"><h3 style="margin:0;">üìã Kos√°r</h3></div>
                <div class="card-body">
                    <div id="cartItems" style="min-height: 100px;">
                        <p class="text-muted text-center"><em>A kos√°r √ºres</em></p>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="order-total">
                        <span>V√©g√∂sszeg:</span>
                        <span id="totalPrice" style="color: var(--brand-accent);">0 Ft</span>
                    </div>
                    <button type="submit" class="btn btn-accent btn-lg w-full mt-md" id="submitButton" disabled>Rendel√©s lead√°sa</button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</form>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if not bufe.rendkivuli_zarva %}
<script>
    const quantityInputs = document.querySelectorAll('.quantity-input');
    const cartItemsDiv = document.getElementById('cartItems');
    const totalPriceSpan = document.getElementById('totalPrice');
    const submitButton = document.getElementById('submitButton');
    const breakSelect = document.getElementById('id_szunet_valasztas');
    const datetimeInput = document.getElementById('id_idozitve');
    const todayButton = document.getElementById('todayButton');
    const openingHoursWarning = document.getElementById('openingHoursWarning');
    const orderForm = document.getElementById('orderForm');
    
    // Store opening hours
    let openingHoursData = null;
    
    // Fetch opening hours from API
    fetch('{% url "bufe:api_opening_hours" %}')
        .then(response => response.json())
        .then(data => {
            openingHoursData = data;
            console.log('Opening hours loaded:', data);
        })
        .catch(error => console.error('Error loading opening hours:', error));
    
    function updateCart() {
        let total = 0, items = [];
        quantityInputs.forEach(input => {
            const quantity = parseInt(input.value) || 0;
            const price = parseFloat(input.dataset.price);
            const name = input.dataset.name;
            if (quantity > 0) {
                const subtotal = quantity * price;
                total += subtotal;
                items.push({name, quantity, price, subtotal});
            }
        });
        
        if (items.length === 0) {
            cartItemsDiv.innerHTML = '<p class="text-muted text-center"><em>A kos√°r √ºres</em></p>';
            submitButton.disabled = true;
        } else {
            let html = '<div style="display: flex; flex-direction: column; gap: var(--space-sm);">';
            items.forEach(item => {
                html += '<div class="order-item"><div><div class="order-item-name">' + item.name + '</div><span class="order-item-quantity">' + item.quantity + ' db √ó ' + item.price + ' Ft</span></div><div class="order-item-price">' + item.subtotal + ' Ft</div></div>';
            });
            html += '</div>';
            cartItemsDiv.innerHTML = html;
            submitButton.disabled = false;
        }
        totalPriceSpan.textContent = total.toLocaleString('hu-HU') + ' Ft';
    }
    
    function formatDateTimeLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hour = String(date.getHours()).padStart(2, '0');
        const minute = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hour}:${minute}`;
    }
    
    function checkOpeningHours(datetime) {
        if (!openingHoursData || !datetime) return null;
        
        // Check if exceptionally closed
        if (openingHoursData.rendkivuli_zarva) {
            return {
                isOpen: false,
                message: 'A b√ºf√© rendk√≠v√ºli z√°rva tart.'
            };
        }
        
        const selectedDate = new Date(datetime);
        const weekday = (selectedDate.getDay() + 6) % 7; // Convert Sunday=0 to Monday=0
        const timeStr = selectedDate.getHours().toString().padStart(2, '0') + ':' + 
                       selectedDate.getMinutes().toString().padStart(2, '0');
        
        // Find matching opening hours
        const dayHours = openingHoursData.opening_hours.filter(oh => oh.weekday === weekday);
        
        if (dayHours.length === 0 || dayHours.some(oh => oh.is_closed)) {
            return {
                isOpen: false,
                message: `A b√ºf√© ezen a napon (${getDayName(weekday)}) z√°rva van.`
            };
        }
        
        // Check if time is within any opening period
        for (let oh of dayHours) {
            if (oh.from_hour && oh.to_hour) {
                if (timeStr >= oh.from_hour && timeStr <= oh.to_hour) {
                    return {
                        isOpen: true,
                        message: `Nyitva: ${oh.from_hour} - ${oh.to_hour}`
                    };
                }
            }
        }
        
        return {
            isOpen: false,
            message: `A b√ºf√© ekkor z√°rva van. Nyitvatart√°s: ${dayHours.map(oh => oh.from_hour + '-' + oh.to_hour).join(', ')}`
        };
    }
    
    function getDayName(weekday) {
        const days = ['H√©tf≈ë', 'Kedd', 'Szerda', 'Cs√ºt√∂rt√∂k', 'P√©ntek', 'Szombat', 'Vas√°rnap'];
        return days[weekday] || '';
    }
    
    function validateAndShowWarning() {
        if (!datetimeInput.value) {
            openingHoursWarning.style.display = 'none';
            return;
        }
        
        const result = checkOpeningHours(datetimeInput.value);
        if (result && !result.isOpen) {
            openingHoursWarning.textContent = '‚ö†Ô∏è ' + result.message;
            openingHoursWarning.style.display = 'block';
        } else {
            openingHoursWarning.style.display = 'none';
        }
    }
    
    // Today button - fills in today's date with current time
    if (todayButton && datetimeInput) {
        todayButton.addEventListener('click', function() {
            const now = new Date();
            // Add 15 minutes to ensure it's in the future
            now.setMinutes(now.getMinutes() + 15);
            datetimeInput.value = formatDateTimeLocal(now);
            validateAndShowWarning();
        });
    }
    
    // Break selection to datetime field sync
    if (breakSelect && datetimeInput) {
        breakSelect.addEventListener('change', function() {
            const breakTime = this.value;
            if (breakTime) {
                const now = new Date();
                const [hours, minutes] = breakTime.split(':').map(Number);
                
                // Create datetime for TODAY at the selected break time
                let selectedDate = new Date(now);
                selectedDate.setHours(hours, minutes, 0, 0);
                
                // If the time has already passed today (+ 10 min buffer), use tomorrow
                const minTime = new Date(now.getTime() + 10 * 60000);
                if (selectedDate < minTime) {
                    selectedDate.setDate(selectedDate.getDate() + 1);
                }
                
                datetimeInput.value = formatDateTimeLocal(selectedDate);
                validateAndShowWarning();
            }
        });
    }
    
    // Validate on datetime change
    if (datetimeInput) {
        datetimeInput.addEventListener('change', validateAndShowWarning);
        datetimeInput.addEventListener('input', validateAndShowWarning);
    }
    
    // Form submission validation
    if (orderForm) {
        orderForm.addEventListener('submit', function(e) {
            // Check if items are selected
            let hasItems = false;
            quantityInputs.forEach(input => {
                if (parseInt(input.value) > 0) hasItems = true;
            });
            
            if (!hasItems) {
                e.preventDefault();
                alert('K√©rem v√°lasszon ki legal√°bb egy term√©ket!');
                return;
            }
            
            // Check if datetime is filled
            if (!datetimeInput.value) {
                e.preventDefault();
                alert('K√©rem adja meg az id≈ëz√≠t√©st!');
                return;
            }
            
            // Check opening hours
            const result = checkOpeningHours(datetimeInput.value);
            if (result && !result.isOpen) {
                e.preventDefault();
                if (!confirm('‚ö†Ô∏è ' + result.message + '\n\nBiztosan leadja a rendel√©st erre az id≈ëpontra?')) {
                    return;
                }
            }
            
            // Check 10 minute minimum
            const selectedDate = new Date(datetimeInput.value);
            const minDate = new Date(Date.now() + 10 * 60000);
            if (selectedDate < minDate) {
                e.preventDefault();
                alert('Az id≈ëz√≠t√©snek legal√°bb 10 perccel a jelenlegi id≈ëpont ut√°n kell lennie!');
                return;
            }
        });
    }
    
    // Initialize cart and validation
    quantityInputs.forEach(input => input.addEventListener('input', updateCart));
    updateCart();
    validateAndShowWarning();
</script>
{% endif %}
{% endblock %}
