{% extends 'bufe/base.html' %}
{% load bufe_extras %}

{% block title %}√öj rendel√©s - B√ºf√©{% endblock %}
{% block meta_description %}√öj rendel√©s lead√°sa{% endblock %}
{% block nav_create_active %}active{% endblock %}

{% block extra_styles %}
<style>
    .order-grid {
        display: grid;
        gap: var(--space-lg);
    }
    
    @media (min-width: 1024px) {
        .order-grid {
            grid-template-columns: 2fr 1fr;
        }
    }
    
    @media (max-width: 1023px) {
        .order-grid {
            grid-template-columns: 1fr;
        }
        
        body {
            padding-bottom: 120px; /* Space for fixed bottom cart */
        }
    }

    /* Category Navigation */
    .category-nav {
        position: sticky;
        top: calc(var(--navbar-height, 60px));
        z-index: 100;
        background: var(--white);
        border-bottom: 2px solid var(--gray-200);
        padding: var(--space-md) 0;
        margin-bottom: var(--space-lg);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    
    .category-nav::-webkit-scrollbar {
        display: none;
    }
    
    .category-nav-list {
        display: flex;
        gap: var(--space-sm);
        padding: 0 var(--space-md);
        min-width: max-content;
    }
    
    .category-nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-width: 70px;
        height: 70px;
        background: var(--gray-100);
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        text-decoration: none;
        color: var(--gray-700);
        transition: all var(--transition);
        padding: var(--space-xs);
    }
    
    .category-nav-item.active {
        background: var(--brand-accent);
        border-color: var(--brand-accent);
        color: var(--white);
    }
    
    .category-nav-emoji {
        font-size: 1.75rem;
        line-height: 1;
        margin-bottom: var(--space-xs);
    }
    
    .category-nav-text {
        font-size: 0.6875rem;
        font-weight: 600;
        text-align: center;
        line-height: 1.1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 60px;
    }
    
    /* Hide default datetime input on mobile, keep custom controls */
    @media (max-width: 1023px) {
        /* Hide the default datetime-local input on mobile */
        input[type="datetime-local"] {
            display: none;
        }
        
        /* Show the break selector and today button instead */
        .form-group:has(input[type="datetime-local"]) {
            position: relative;
        }
        
        .form-group:has(input[type="datetime-local"]) .form-label::after {
            content: " (v√°lasszon sz√ºnetet al√°bb)";
            font-weight: normal;
            color: var(--gray-600);
            font-size: 0.875rem;
        }
    }
    
    /* Custom Quantity Controls for Mobile */
    @media (max-width: 1023px) {
        .quantity-control {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }
        
        .quantity-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: var(--brand-accent);
            color: var(--white);
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.25rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition);
            touch-action: manipulation;
            user-select: none;
        }
        
        .quantity-btn:hover:not(:disabled) {
            background: #965f38;
            box-shadow: var(--shadow-md);
        }
        
        .quantity-btn:disabled {
            background: var(--gray-300);
            color: var(--gray-500);
            cursor: not-allowed;
        }
        
        .quantity-input {
            width: 80px;
            text-align: center;
            font-weight: 600;
            font-size: 1.125rem;
            border: 2px solid var(--gray-300);
            padding: var(--space-sm);
        }
        
        .quantity-input:focus {
            border-color: var(--brand-accent);
        }
        
        /* Hide default number input on mobile */
        .form-group:has(.quantity-input) .form-label {
            display: none;
        }
        
        .form-group:has(.quantity-input) {
            margin-bottom: 0;
        }
    }
    
    /* Fixed Bottom Cart for Mobile */
    @media (max-width: 1023px) {
        .mobile-cart {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 3px solid var(--brand-accent);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            padding: var(--space-md);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform var(--transition);
        }
        
        .mobile-cart.active {
            transform: translateY(0);
        }
        
        .mobile-cart-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-md);
        }
        
        .mobile-cart-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }
        
        .mobile-cart-items {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .mobile-cart-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--brand-accent);
        }
        
        .mobile-cart-btn {
            flex-shrink: 0;
            min-width: 120px;
        }
        
        /* Hide desktop cart on mobile */
        .order-grid > div:last-child {
            display: none;
        }
    }
    
    /* Desktop - hide mobile elements */
    @media (min-width: 1024px) {
        .category-nav {
            display: none;
        }
        
        .mobile-cart {
            display: none;
        }
        
        .quantity-control {
            display: none;
        }
    }
    
    /* Smooth scrolling for anchors */
    html {
        scroll-behavior: smooth;
        scroll-padding-top: 140px;
    }
    
    /* Touch improvements */
    @media (max-width: 1023px) {
        .product-card {
            position: relative;
            transition: transform 0.1s ease;
        }
        
        .product-card:active {
            transform: scale(0.98);
        }
        
        /* Better touch targets */
        .category-nav-item {
            -webkit-tap-highlight-color: rgba(168, 110, 67, 0.2);
        }
        
        .quantity-btn {
            -webkit-tap-highlight-color: rgba(168, 110, 67, 0.3);
            -webkit-touch-callout: none;
        }
        
        /* Improve scrolling performance */
        .category-nav {
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        
        /* Loading state for mobile cart */
        .mobile-cart.loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        /* Better spacing for product info on mobile */
        .product-card {
            padding: var(--space-lg);
        }
        
        .product-name {
            font-size: 1.0625rem;
            margin-bottom: var(--space-sm);
        }
        
        .product-price {
            font-size: 1.25rem;
            margin-bottom: var(--space-md);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Rendk√≠v√ºli z√°rva Alert -->
{% if bufe and bufe.rendkivuli_zarva %}
<div class="card mb-lg" style="border: 3px solid #dc3545;">
    <div class="card-body text-center" style="background-color: #f8d7da;">
        <h1 style="color: #721c24; margin-bottom: 1rem;">üö´ A b√ºf√© rendk√≠v√ºli okok miatt z√°rva tart</h1>
        <p style="color: #721c24; font-size: 1.2rem; margin-bottom: 1.5rem;">
            Jelenleg nem fogadunk el rendel√©seket. K√©rj√ºk, n√©zzen vissza k√©s≈ëbb.
        </p>
        {% if user.is_authenticated %}
            {% load bufe_extras %}
            {% if user|is_bufeadmin %}
            <a href="{% url 'bufe:admin_dashboard' %}" class="btn btn-lg" style="background-color: #721c24; color: white;">
                üîß Admin fel√ºlet megnyit√°sa
            </a>
            {% endif %}
        {% endif %}
        <br><br>
        <a href="{% url 'bufe:index' %}" class="btn btn-outline">‚Üê Vissza a f≈ëoldalra</a>
    </div>
</div>
{% else %}
<div class="card mb-lg">
    <div class="card-body">
        <h1>üõí √öj rendel√©s lead√°sa</h1>
        <p class="text-muted">V√°lassza ki a k√≠v√°nt term√©keket</p>
    </div>
</div>

<!-- Category Navigation for Mobile -->
{% if termekek_by_kategoria %}
<nav class="category-nav">
    <div class="category-nav-list">
        {% for kategoria, termekek in termekek_by_kategoria.items %}
        <a href="#kategoria-{{ kategoria.id }}" class="category-nav-item" data-category="{{ kategoria.id }}">
            <span class="category-nav-emoji">{{ kategoria.nev|get_category_emoji }}</span>
            <span class="category-nav-text">{{ kategoria.nev }}</span>
        </a>
        {% endfor %}
    </div>
</nav>
{% endif %}

{% if not is_open %}
<div class="alert alert-warning">
    <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
    <div><strong>Figyelem!</strong> A b√ºf√© jelenleg z√°rva van.</div>
</div>
{% endif %}

{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }}">{{ message }}</div>
{% endfor %}
{% endif %}

<form method="post" id="orderForm">
    {% csrf_token %}
    <div class="order-grid">
        <div>
            {% if termekek_by_kategoria %}
            {% for kategoria, termekek in termekek_by_kategoria.items %}
            <div class="card mb-lg" id="kategoria-{{ kategoria.id }}">
                <div class="card-header"><h3 style="margin:0;">{{ kategoria.nev|get_category_emoji }} {{ kategoria.nev }}</h3></div>
                <div class="card-body">
                    <div class="grid grid-2">
                        {% for termek in termekek %}
                        <div class="product-card">
                            <div class="product-name">{{ termek.nev }}</div>
                            <div class="product-price">{{ termek.ar }} Ft</div>
                            {% if termek.leiras %}<div class="product-description">{{ termek.leiras }}</div>{% endif %}
                            <div style="display: flex; gap: var(--space-xs); flex-wrap: wrap; margin-bottom: var(--space-md);">
                                {% if termek.hutve %}<span class="badge badge-info">‚ùÑÔ∏è H≈±tve</span>{% endif %}
                                {% if termek.kisult %}<span class="badge badge-warning">‚ö†Ô∏è Kis√ºlt</span>{% endif %}
                                <span class="badge badge-gray">Max {{ termek.max_rendelesenkent }} db</span>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" for="quantity_{{ termek.id }}">Mennyis√©g</label>
                                <input type="number" name="quantity_{{ termek.id }}" id="quantity_{{ termek.id }}" class="form-control quantity-input" min="0" max="{{ termek.max_rendelesenkent }}" value="0" data-price="{{ termek.ar }}" data-name="{{ termek.nev }}">
                                <!-- Mobile Quantity Control -->
                                <div class="quantity-control">
                                    <button type="button" class="quantity-btn" data-action="decrease" data-target="quantity_{{ termek.id }}">‚àí</button>
                                    <span class="quantity-display" id="display_{{ termek.id }}">0</span>
                                    <button type="button" class="quantity-btn" data-action="increase" data-target="quantity_{{ termek.id }}" data-max="{{ termek.max_rendelesenkent }}">+</button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}

            <div class="card">
                <div class="card-header"><h3 style="margin:0;">üìù Rendel√©s r√©szletei</h3></div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.szunet_valasztas.id_for_label }}">{{ form.szunet_valasztas.label }}</label>
                        {{ form.szunet_valasztas }}
                        {% if form.szunet_valasztas.help_text %}
                        <small class="text-muted">{{ form.szunet_valasztas.help_text }}</small>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="{{ form.idozitve.id_for_label }}">{{ form.idozitve.label }} <span style="color: var(--danger);">*</span></label>
                        <div style="display: flex; gap: var(--space-sm); flex-wrap: wrap;">
                            {{ form.idozitve }}
                            <button type="button" class="btn btn-secondary" id="todayButton" title="Mai d√°tum kit√∂lt√©se" style="white-space: nowrap;">üìÖ Ma</button>
                        </div>
                        <small class="text-muted">Legal√°bb 10 perccel a jelenlegi id≈ëpont ut√°n kell lennie</small>
                        <div id="openingHoursWarning" style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: var(--warning); border-radius: var(--border-radius); color: #000;">
                            ‚ö†Ô∏è A kiv√°lasztott id≈ëpont a b√ºf√© nyitvatart√°si idej√©n k√≠v√ºl esik!
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" for="{{ form.megjegyzes.id_for_label }}">{{ form.megjegyzes.label }}</label>
                        {{ form.megjegyzes }}
                    </div>
                    {% if form.errors %}
                    <div class="alert alert-error mt-md">
                        {% for field, errors in form.errors.items %}
                        {% for error in errors %}<p>{{ error }}</p>{% endfor %}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="card">
                <div class="card-body text-center">
                    <h3>Jelenleg nincsenek el√©rhet≈ë term√©kek</h3>
                    <p class="text-muted">K√©rj√ºk, pr√≥b√°lja √∫jra k√©s≈ëbb.</p>
                </div>
            </div>
            {% endif %}
        </div>

        {% if termekek_by_kategoria %}
        <div>
            <div class="card" style="position: sticky; top: calc(var(--space-md) + 60px);">
                <div class="card-header"><h3 style="margin:0;">üìã Kos√°r</h3></div>
                <div class="card-body">
                    <div id="cartItems" style="min-height: 100px;">
                        <p class="text-muted text-center"><em>A kos√°r √ºres</em></p>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="order-total">
                        <span>V√©g√∂sszeg:</span>
                        <span id="totalPrice" style="color: var(--brand-accent);">0 Ft</span>
                    </div>
                    <button type="submit" class="btn btn-accent btn-lg w-full mt-md" id="submitButton" disabled>Rendel√©s lead√°sa</button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</form>

<!-- Mobile Fixed Bottom Cart -->
<div class="mobile-cart" id="mobileCart">
    <div class="mobile-cart-content">
        <div class="mobile-cart-info">
            <div class="mobile-cart-items" id="mobileCartItems">Kos√°r √ºres</div>
            <div class="mobile-cart-total" id="mobileCartTotal">0 Ft</div>
        </div>
        <button type="submit" form="orderForm" class="btn btn-accent btn-lg mobile-cart-btn" id="mobileSubmitButton" disabled>
            Rendel√©s lead√°sa
        </button>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if not bufe.rendkivuli_zarva %}
<script>
    const quantityInputs = document.querySelectorAll('.quantity-input');
    const cartItemsDiv = document.getElementById('cartItems');
    const totalPriceSpan = document.getElementById('totalPrice');
    const submitButton = document.getElementById('submitButton');
    const breakSelect = document.getElementById('id_szunet_valasztas');
    const datetimeInput = document.getElementById('id_idozitve');
    const todayButton = document.getElementById('todayButton');
    const openingHoursWarning = document.getElementById('openingHoursWarning');
    const orderForm = document.getElementById('orderForm');
    
    // Store opening hours
    let openingHoursData = null;
    
    // Fetch opening hours from API
    fetch('{% url "bufe:api_opening_hours" %}')
        .then(response => response.json())
        .then(data => {
            openingHoursData = data;
            console.log('Opening hours loaded:', data);
        })
        .catch(error => console.error('Error loading opening hours:', error));
    
    function updateCart() {
        let total = 0, items = [];
        quantityInputs.forEach(input => {
            const quantity = parseInt(input.value) || 0;
            const price = parseFloat(input.dataset.price);
            const name = input.dataset.name;
            if (quantity > 0) {
                const subtotal = quantity * price;
                total += subtotal;
                items.push({name, quantity, price, subtotal});
            }
        });
        
        if (items.length === 0) {
            cartItemsDiv.innerHTML = '<p class="text-muted text-center"><em>A kos√°r √ºres</em></p>';
            submitButton.disabled = true;
        } else {
            let html = '<div style="display: flex; flex-direction: column; gap: var(--space-sm);">';
            items.forEach(item => {
                html += '<div class="order-item"><div><div class="order-item-name">' + item.name + '</div><span class="order-item-quantity">' + item.quantity + ' db √ó ' + item.price + ' Ft</span></div><div class="order-item-price">' + item.subtotal + ' Ft</div></div>';
            });
            html += '</div>';
            cartItemsDiv.innerHTML = html;
            submitButton.disabled = false;
        }
        totalPriceSpan.textContent = total.toLocaleString('hu-HU') + ' Ft';
    }
    
    function formatDateTimeLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hour = String(date.getHours()).padStart(2, '0');
        const minute = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hour}:${minute}`;
    }
    
    function checkOpeningHours(datetime) {
        if (!openingHoursData || !datetime) return null;
        
        // Check if exceptionally closed
        if (openingHoursData.rendkivuli_zarva) {
            return {
                isOpen: false,
                message: 'A b√ºf√© rendk√≠v√ºli z√°rva tart.'
            };
        }
        
        const selectedDate = new Date(datetime);
        const weekday = (selectedDate.getDay() + 6) % 7; // Convert Sunday=0 to Monday=0
        const timeStr = selectedDate.getHours().toString().padStart(2, '0') + ':' + 
                       selectedDate.getMinutes().toString().padStart(2, '0');
        
        // Find matching opening hours
        const dayHours = openingHoursData.opening_hours.filter(oh => oh.weekday === weekday);
        
        if (dayHours.length === 0 || dayHours.some(oh => oh.is_closed)) {
            return {
                isOpen: false,
                message: `A b√ºf√© ezen a napon (${getDayName(weekday)}) z√°rva van.`
            };
        }
        
        // Check if time is within any opening period
        for (let oh of dayHours) {
            if (oh.from_hour && oh.to_hour) {
                if (timeStr >= oh.from_hour && timeStr <= oh.to_hour) {
                    return {
                        isOpen: true,
                        message: `Nyitva: ${oh.from_hour} - ${oh.to_hour}`
                    };
                }
            }
        }
        
        return {
            isOpen: false,
            message: `A b√ºf√© ekkor z√°rva van. Nyitvatart√°s: ${dayHours.map(oh => oh.from_hour + '-' + oh.to_hour).join(', ')}`
        };
    }
    
    function getDayName(weekday) {
        const days = ['H√©tf≈ë', 'Kedd', 'Szerda', 'Cs√ºt√∂rt√∂k', 'P√©ntek', 'Szombat', 'Vas√°rnap'];
        return days[weekday] || '';
    }
    
    function validateAndShowWarning() {
        if (!datetimeInput.value) {
            openingHoursWarning.style.display = 'none';
            return;
        }
        
        const result = checkOpeningHours(datetimeInput.value);
        if (result && !result.isOpen) {
            openingHoursWarning.textContent = '‚ö†Ô∏è ' + result.message;
            openingHoursWarning.style.display = 'block';
        } else {
            openingHoursWarning.style.display = 'none';
        }
    }
    
    // Today button - fills in today's date with current time
    if (todayButton && datetimeInput) {
        todayButton.addEventListener('click', function() {
            const now = new Date();
            // Add 15 minutes to ensure it's in the future
            now.setMinutes(now.getMinutes() + 15);
            datetimeInput.value = formatDateTimeLocal(now);
            validateAndShowWarning();
        });
    }
    
    // Break selection to datetime field sync
    if (breakSelect && datetimeInput) {
        breakSelect.addEventListener('change', function() {
            const breakTime = this.value;
            if (breakTime) {
                const now = new Date();
                const [hours, minutes] = breakTime.split(':').map(Number);
                
                // Create datetime for TODAY at the selected break time
                let selectedDate = new Date(now);
                selectedDate.setHours(hours, minutes, 0, 0);
                
                // If the time has already passed today (+ 10 min buffer), use tomorrow
                const minTime = new Date(now.getTime() + 10 * 60000);
                if (selectedDate < minTime) {
                    selectedDate.setDate(selectedDate.getDate() + 1);
                }
                
                datetimeInput.value = formatDateTimeLocal(selectedDate);
                validateAndShowWarning();
            }
        });
    }
    
    // Validate on datetime change
    if (datetimeInput) {
        datetimeInput.addEventListener('change', validateAndShowWarning);
        datetimeInput.addEventListener('input', validateAndShowWarning);
    }
    
    // Form submission validation
    if (orderForm) {
        orderForm.addEventListener('submit', function(e) {
            // Check if items are selected
            let hasItems = false;
            quantityInputs.forEach(input => {
                if (parseInt(input.value) > 0) hasItems = true;
            });
            
            if (!hasItems) {
                e.preventDefault();
                alert('K√©rem v√°lasszon ki legal√°bb egy term√©ket!');
                return;
            }
            
            // Check if datetime is filled
            if (!datetimeInput.value) {
                e.preventDefault();
                alert('K√©rem adja meg az id≈ëz√≠t√©st!');
                return;
            }
            
            // Check opening hours
            const result = checkOpeningHours(datetimeInput.value);
            if (result && !result.isOpen) {
                e.preventDefault();
                if (!confirm('‚ö†Ô∏è ' + result.message + '\n\nBiztosan leadja a rendel√©st erre az id≈ëpontra?')) {
                    return;
                }
            }
            
            // Check 10 minute minimum
            const selectedDate = new Date(datetimeInput.value);
            const minDate = new Date(Date.now() + 10 * 60000);
            if (selectedDate < minDate) {
                e.preventDefault();
                alert('Az id≈ëz√≠t√©snek legal√°bb 10 perccel a jelenlegi id≈ëpont ut√°n kell lennie!');
                return;
            }
        });
    }
    
    // Mobile quantity controls
    function setupMobileQuantityControls() {
        const quantityButtons = document.querySelectorAll('.quantity-btn');
        
        quantityButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Add visual feedback
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 100);
                
                const action = this.dataset.action;
                const targetId = this.dataset.target;
                const input = document.getElementById(targetId);
                const display = document.getElementById('display_' + targetId.split('_')[1]);
                
                if (!input || !display) return;
                
                let currentValue = parseInt(input.value) || 0;
                const max = parseInt(input.getAttribute('max')) || 999;
                const min = parseInt(input.getAttribute('min')) || 0;
                
                if (action === 'increase' && currentValue < max) {
                    currentValue++;
                } else if (action === 'decrease' && currentValue > min) {
                    currentValue--;
                }
                
                input.value = currentValue;
                display.textContent = currentValue;
                
                // Update button states
                updateQuantityButtonStates(targetId, currentValue, min, max);
                
                // Trigger cart update with slight delay for better UX
                setTimeout(() => {
                    input.dispatchEvent(new Event('input'));
                }, 50);
            });
            
            // Add touch feedback
            button.addEventListener('touchstart', function(e) {
                this.style.backgroundColor = '#965f38';
            });
            
            button.addEventListener('touchend', function(e) {
                setTimeout(() => {
                    if (!this.disabled) {
                        this.style.backgroundColor = '';
                    }
                }, 150);
            });
        });
        
        // Function to update button states
        function updateQuantityButtonStates(targetId, currentValue, min = 0, max = 999) {
            const decreaseBtn = document.querySelector(`[data-action="decrease"][data-target="${targetId}"]`);
            const increaseBtn = document.querySelector(`[data-action="increase"][data-target="${targetId}"]`);
            
            if (decreaseBtn) {
                decreaseBtn.disabled = currentValue <= min;
                decreaseBtn.style.opacity = currentValue <= min ? '0.4' : '1';
            }
            if (increaseBtn) {
                increaseBtn.disabled = currentValue >= max;
                increaseBtn.style.opacity = currentValue >= max ? '0.4' : '1';
            }
        }
        
        // Sync displays with inputs on page load
        quantityInputs.forEach(input => {
            const productId = input.id.split('_')[1];
            const display = document.getElementById('display_' + productId);
            const currentValue = parseInt(input.value) || 0;
            const min = parseInt(input.getAttribute('min')) || 0;
            const max = parseInt(input.getAttribute('max')) || 999;
            
            if (display) {
                display.textContent = currentValue;
            }
            
            updateQuantityButtonStates(input.id, currentValue, min, max);
            
            // Also listen to direct input changes to sync display
            input.addEventListener('input', function() {
                const newValue = parseInt(this.value) || 0;
                if (display) {
                    display.textContent = newValue;
                }
                updateQuantityButtonStates(this.id, newValue, min, max);
            });
        });
    }
    
    // Category navigation active state
    function updateCategoryNavigation() {
        const navItems = document.querySelectorAll('.category-nav-item');
        const sections = document.querySelectorAll('[id^="kategoria-"]');
        
        function setActiveNav() {
            let current = '';
            sections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (rect.top <= 200) {
                    current = section.id;
                }
            });
            
            navItems.forEach(item => {
                item.classList.remove('active');
                const categoryId = item.dataset.category;
                if (current === `kategoria-${categoryId}`) {
                    item.classList.add('active');
                }
            });
        }
        
        window.addEventListener('scroll', setActiveNav);
        setActiveNav();
    }
    
    // Mobile cart functionality
    function updateMobileCart() {
        const mobileCart = document.getElementById('mobileCart');
        const mobileCartItems = document.getElementById('mobileCartItems');
        const mobileCartTotal = document.getElementById('mobileCartTotal');
        const mobileSubmitButton = document.getElementById('mobileSubmitButton');
        
        if (!mobileCart) return;
        
        let total = 0, itemCount = 0;
        const items = [];
        
        quantityInputs.forEach(input => {
            const quantity = parseInt(input.value) || 0;
            const price = parseFloat(input.dataset.price);
            const name = input.dataset.name;
            if (quantity > 0) {
                total += quantity * price;
                itemCount += quantity;
                items.push({ name, quantity });
            }
        });
        
        if (itemCount > 0) {
            mobileCart.classList.add('active');
            
            // Create more detailed item text
            let itemText = '';
            if (items.length === 1) {
                itemText = `${items[0].quantity}x ${items[0].name}`;
                if (itemText.length > 25) {
                    itemText = `${itemCount} term√©k`;
                }
            } else if (items.length <= 3) {
                itemText = `${itemCount} term√©k (${items.length} f√©le)`;
            } else {
                itemText = `${itemCount} term√©k (${items.length} f√©le)`;
            }
            
            mobileCartItems.textContent = itemText;
            mobileCartTotal.textContent = total.toLocaleString('hu-HU') + ' Ft';
            mobileSubmitButton.disabled = false;
            
            // Add subtle animation when cart updates
            mobileCart.style.transform = 'translateY(-5px)';
            setTimeout(() => {
                mobileCart.style.transform = '';
            }, 200);
        } else {
            mobileCart.classList.remove('active');
            mobileCartItems.textContent = 'Kos√°r √ºres';
            mobileCartTotal.textContent = '0 Ft';
            mobileSubmitButton.disabled = true;
        }
    }
    
    // Enhanced updateCart function
    function updateCart() {
        let total = 0, items = [];
        quantityInputs.forEach(input => {
            const quantity = parseInt(input.value) || 0;
            const price = parseFloat(input.dataset.price);
            const name = input.dataset.name;
            if (quantity > 0) {
                const subtotal = quantity * price;
                total += subtotal;
                items.push({name, quantity, price, subtotal});
            }
        });
        
        if (items.length === 0) {
            cartItemsDiv.innerHTML = '<p class="text-muted text-center"><em>A kos√°r √ºres</em></p>';
            submitButton.disabled = true;
        } else {
            let html = '<div style="display: flex; flex-direction: column; gap: var(--space-sm);">';
            items.forEach(item => {
                html += '<div class="order-item"><div><div class="order-item-name">' + item.name + '</div><span class="order-item-quantity">' + item.quantity + ' db √ó ' + item.price + ' Ft</span></div><div class="order-item-price">' + item.subtotal + ' Ft</div></div>';
            });
            html += '</div>';
            cartItemsDiv.innerHTML = html;
            submitButton.disabled = false;
        }
        totalPriceSpan.textContent = total.toLocaleString('hu-HU') + ' Ft';
        
        // Update mobile cart
        updateMobileCart();
    }
    
    // Initialize everything
    quantityInputs.forEach(input => input.addEventListener('input', updateCart));
    updateCart();
    validateAndShowWarning();
    
    // Initialize mobile features on mobile devices
    if (window.innerWidth <= 1023) {
        setupMobileQuantityControls();
        updateCategoryNavigation();
    }
</script>
{% endif %}
{% endblock %}
