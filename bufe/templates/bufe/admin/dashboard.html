{% load static %}
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√ºf√© Admin - Rendel√©sek</title>
    <style>
/**
 * B√ºf√© Admin Interface Styles (inline due to static file handling issue)
 */

/* Reset & Base */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: #f5f7fa;
    color: #2c3e50;
    line-height: 1.6;
}

/* Admin Container */
.admin-container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Header */
.admin-header {
    background: #2c3e50;
    color: white;
    padding: 1rem 2rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

@media (max-width: 768px) {
    .admin-header {
        padding: 1rem 1.5rem;
    }
}

@media (max-width: 480px) {
    .admin-header {
        padding: 1rem 1.25rem;
    }
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.admin-header h1 {
    font-size: 1.5rem;
    font-weight: 600;
}

.header-info {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.user-name {
    font-size: 0.95rem;
    opacity: 0.9;
}

.connection-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.8rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    font-size: 0.85rem;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #95a5a6;
    animation: pulse 2s infinite;
}

.connection-status.connected .status-dot {
    background: #2ecc71;
}

.connection-status.disconnected .status-dot {
    background: #f39c12;
}

.connection-status.error .status-dot {
    background: #e74c3c;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Navigation */
.admin-nav {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.nav-link {
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    transition: all 0.3s;
    font-size: 0.9rem;
}

.nav-link:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

.nav-link.active {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

/* Main Content */
.admin-main {
    flex: 1;
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
    width: 100%;
}

@media (max-width: 768px) {
    .admin-main {
        padding: 1.5rem;
    }
}

@media (max-width: 480px) {
    .admin-main {
        padding: 1rem 1.25rem;
    }
}

/* Controls Bar */
.controls-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.controls-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.controls-left h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2c3e50;
}

.order-count {
    background: #3498db;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.controls-right {
    display: flex;
    gap: 0.5rem;
}

.emergency-close {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Buttons */
.btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background: #7f8c8d;
}

.btn-danger {
    background: #e74c3c;
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

/* Filter Tabs */
.filter-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.filter-tab {
    padding: 0.6rem 1.2rem;
    border: 2px solid #ecf0f1;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
    font-weight: 500;
}

.filter-tab:hover {
    border-color: #3498db;
    color: #3498db;
}

.filter-tab.active {
    background: #3498db;
    border-color: #3498db;
    color: white;
}

/* Orders Grid */
.orders-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
}

@media (max-width: 768px) {
    .orders-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
}

@media (max-width: 480px) {
    .orders-grid {
        gap: 1rem;
    }
}

.no-orders {
    grid-column: 1 / -1;
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 12px;
    color: #95a5a6;
    font-size: 1.1rem;
}

/* Order Card */
.order-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: all 0.3s;
    cursor: pointer;
    border: 2px solid transparent;
}

.order-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
    border-color: #3498db;
}

.order-card.flash {
    animation: flashAnimation 0.5s ease-in-out 4;
}

@keyframes flashAnimation {
    0%, 100% { background: white; }
    50% { background: #fff3cd; }
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f8f9fa;
    border-bottom: 1px solid #ecf0f1;
}

@media (max-width: 480px) {
    .order-header {
        padding: 1rem 1.25rem;
    }
}

.order-number {
    font-size: 1.2rem;
    font-weight: 700;
    color: #2c3e50;
}

.order-status {
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-leadva {
    background: #fff3cd;
    color: #856404;
}

.status-visszaigasolva {
    background: #d1ecf1;
    color: #0c5460;
}

.status-atadva {
    background: #d4edda;
    color: #155724;
}

.status-torolve {
    background: #f8d7da;
    color: #721c24;
}

.status-visszavonva {
    background: #e2e3e5;
    color: #383d41;
}

.order-body {
    padding: 1rem;
}

@media (max-width: 480px) {
    .order-body {
        padding: 1rem 1.25rem;
    }
}

.order-user {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
    color: #2c3e50;
}

.order-time {
    font-size: 0.85rem;
    color: #7f8c8d;
    margin-bottom: 0.8rem;
}

.order-items-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-bottom: 0.8rem;
}

.item-badge {
    background: #ecf0f1;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    font-size: 0.8rem;
    color: #2c3e50;
}

.order-total {
    font-size: 1.3rem;
    font-weight: 700;
    color: #27ae60;
    margin-bottom: 0.5rem;
}

.order-note {
    background: #fff3cd;
    padding: 0.6rem;
    border-radius: 6px;
    font-size: 0.85rem;
    color: #856404;
    margin-top: 0.5rem;
}

.order-actions {
    padding: 1rem;
    background: #f8f9fa;
    display: flex;
    gap: 0.5rem;
    border-top: 1px solid #ecf0f1;
}

@media (max-width: 480px) {
    .order-actions {
        padding: 1rem 1.25rem;
        flex-direction: column;
    }
    
    .btn-action {
        width: 100%;
    }
}

.btn-action {
    flex: 1;
    padding: 0.6rem 0.8rem;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-confirm {
    background: #3498db;
    color: white;
}

.btn-confirm:hover {
    background: #2980b9;
}

.btn-done {
    background: #27ae60;
    color: white;
}

.btn-done:hover {
    background: #229954;
}

.btn-delete {
    background: #e74c3c;
    color: white;
}

.btn-delete:hover {
    background: #c0392b;
}

.btn-undo {
    background: #f39c12;
    color: white;
}

.btn-undo:hover {
    background: #e67e22;
}

.btn-archive {
    background: #95a5a6;
    color: white;
}

.btn-archive:hover {
    background: #7f8c8d;
}

.btn-edit {
    background: #3498db;
    color: white;
    padding: 0.4rem 0.8rem;
    text-decoration: none;
    border-radius: 4px;
    display: inline-block;
}

.btn-edit:hover {
    background: #2980b9;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.modal-content {
    background: white;
    border-radius: 12px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #ecf0f1;
}

.modal-header h3 {
    font-size: 1.3rem;
    color: #2c3e50;
}

.modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    color: #95a5a6;
    cursor: pointer;
    line-height: 1;
    transition: color 0.3s;
}

.modal-close:hover {
    color: #2c3e50;
}

.modal-body {
    padding: 1.5rem;
}

.modal-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
}

.modal-warning {
    color: #e74c3c;
    font-weight: 600;
    margin-top: 1rem;
}

/* Order Detail */
.order-detail {
    font-size: 0.95rem;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: 0.8rem 0;
    border-bottom: 1px solid #ecf0f1;
}

.detail-label {
    font-weight: 600;
    color: #7f8c8d;
}

.detail-value {
    color: #2c3e50;
}

.order-detail h4 {
    margin: 1.5rem 0 1rem;
    color: #2c3e50;
}

.items-table {
    width: 100%;
    border-collapse: collapse;
}

.items-table th,
.items-table td {
    padding: 0.8rem;
    text-align: left;
    border-bottom: 1px solid #ecf0f1;
}

.items-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #2c3e50;
}

.items-table tfoot td {
    font-weight: 700;
    border-top: 2px solid #2c3e50;
}

.text-center {
    text-align: center !important;
}

.text-right {
    text-align: right !important;
}

/* Menu Management */
.menu-sections {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.menu-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.menu-section h3 {
    font-size: 1.3rem;
    color: #2c3e50;
    margin-bottom: 1rem;
}

.products-table {
    overflow-x: auto;
}

.products-table table {
    width: 100%;
    border-collapse: collapse;
}

.products-table th,
.products-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #ecf0f1;
}

.products-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #2c3e50;
}

.product-row.product-unavailable {
    opacity: 0.5;
}

.inline-edit {
    width: 100%;
    padding: 0.4rem;
    border: 1px solid #ecf0f1;
    border-radius: 4px;
    font-size: 0.9rem;
}

.inline-edit:focus {
    outline: none;
    border-color: #3498db;
}

/* Toggle Switch */
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 24px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #2ecc71;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

/* Opening Hours */
.opening-hours-table {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
}

.opening-hours-table table {
    width: 100%;
    border-collapse: collapse;
}

.opening-hours-table th,
.opening-hours-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #ecf0f1;
}

.opening-hours-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #2c3e50;
}

.time-slot {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.time-slot input[type="time"] {
    padding: 0.4rem;
    border: 1px solid #ecf0f1;
    border-radius: 4px;
    font-size: 0.9rem;
}

/* Info Box */
.info-box {
    background: #e8f4f8;
    border-left: 4px solid #3498db;
    padding: 1rem 1.5rem;
    border-radius: 6px;
    margin-top: 2rem;
}

.info-box p {
    margin: 0.5rem 0;
    color: #2c3e50;
}

.info-box a {
    color: #3498db;
    text-decoration: none;
    font-weight: 600;
}

.info-box a:hover {
    text-decoration: underline;
}

/* Toast Notification */
.toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: #27ae60;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    opacity: 0;
    transform: translateY(100px);
    transition: all 0.3s;
    z-index: 2000;
}

.toast.show {
    opacity: 1;
    transform: translateY(0);
}

/* Responsive Design */
@media (max-width: 768px) {
    .admin-main {
        padding: 1rem;
    }
    
    .orders-grid {
        grid-template-columns: 1fr;
    }
    
    .controls-bar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .controls-right {
        flex-direction: column;
    }
    
    .header-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .admin-nav {
        flex-direction: column;
    }
    
    .products-table {
        font-size: 0.85rem;
    }
    
    .products-table th,
    .products-table td {
        padding: 0.5rem;
    }
    
    .filter-tabs {
        gap: 0.4rem;
    }
    
    .filter-tab {
        padding: 0.5rem 0.8rem;
        font-size: 0.85rem;
    }
}

@media (max-width: 480px) {
    .admin-header h1 {
        font-size: 1.25rem;
    }
    
    .controls-left h2 {
        font-size: 1.25rem;
    }
    
    .order-number {
        font-size: 1rem;
    }
    
    .order-status {
        padding: 0.25rem 0.6rem;
        font-size: 0.75rem;
    }
    
    .order-total {
        font-size: 1.15rem;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }
    
    .modal-content {
        margin: 1rem;
    }
    
    .modal-header,
    .modal-body {
        padding: 1.25rem;
    }
    
    .menu-section {
        padding: 1.25rem;
    }
    
    .opening-hours-table {
        padding: 1.25rem;
    }
    
    .toast {
        bottom: 1rem;
        right: 1rem;
        left: 1rem;
        padding: 1rem 1.25rem;
    }
}
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-content">
                <h1>üìã B√ºf√© Adminisztr√°ci√≥</h1>
                <div class="header-info">
                    <span class="user-name">{{user.last_name}} {{user.first_name}}</span>
                    <span class="connection-status" id="connectionStatus">
                        <span class="status-dot"></span>
                        <span class="status-text">Csatlakoz√°s...</span>
                    </span>
                </div>
            </div>
            <nav class="admin-nav">
                <a href="{% url 'bufe:admin_dashboard' %}" class="nav-link active">Rendel√©sek</a>
                <a href="{% url 'bufe:admin_menu_management' %}" class="nav-link">Men√º kezel√©s</a>
                <a href="{% url 'bufe:admin_opening_hours' %}" class="nav-link">Nyitvatart√°s</a>
                <a href="{% url 'bufe:index' %}" class="nav-link">B√ºf√© oldal</a>
                <a href="/logout/" class="nav-link">Kijelentkez√©s</a>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Controls -->
            <div class="controls-bar">
                <div class="controls-left">
                    <h2>√âl≈ë rendel√©sek</h2>
                    <span class="order-count" id="orderCount">0 rendel√©s</span>
                </div>
                <div class="controls-right">
                    <button class="btn btn-secondary" id="refreshBtn">
                        üîÑ Friss√≠t√©s
                    </button>
                    <button class="btn btn-danger" id="archiveAllBtn">
                        üì¶ √ñsszes k√©sz archiv√°l√°sa
                    </button>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">√ñsszes</button>
                <button class="filter-tab" data-filter="leadva">Leadva</button>
                <button class="filter-tab" data-filter="visszaigasolva">Visszaigazolva</button>
                <button class="filter-tab" data-filter="atadva">K√©sz</button>
                <button class="filter-tab" data-filter="torolve">T√∂r√∂lve</button>
                <button class="filter-tab" data-filter="visszavonva">Visszavonva</button>
            </div>

            <!-- Orders Grid -->
            <div class="orders-grid" id="ordersGrid">
                {% if active_orders %}
                    {% for rendeles in active_orders %}
                    <div class="order-card" data-order-id="{{ rendeles.id }}" data-status="{{ rendeles.allapot }}">
                        <div class="order-header">
                            <div class="order-number">#{{ rendeles.id }}</div>
                            <div class="order-status status-{{ rendeles.allapot }}">
                                {{ rendeles.get_allapot_display }}
                            </div>
                        </div>
                        <div class="order-body">
                            <div class="order-user">
                                <strong>{{ rendeles.user.last_name }} {{ rendeles.user.first_name }}</strong>
                            </div>
                            <div class="order-time">
                                {{ rendeles.leadva|date:"Y.m.d H:i" }}
                            </div>
                            <div class="order-items-preview">
                                {% for item in rendeles.items %}
                                    {% if forloop.counter <= 3 %}
                                        <span class="item-badge">{{ item.db }}x Term√©k #{{ item.termek_id }}</span>
                                    {% endif %}
                                {% endfor %}
                                {% if rendeles.items|length > 3 %}
                                    <span class="item-badge">+{{ rendeles.items|length|add:"-3" }} tov√°bbi</span>
                                {% endif %}
                            </div>
                            <div class="order-total">
                                {{ rendeles.vegosszeg }} Ft
                            </div>
                            {% if rendeles.megjegyzes %}
                            <div class="order-note">
                                üí¨ {{ rendeles.megjegyzes }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="order-actions">
                            {% if rendeles.allapot == 'leadva' %}
                                <button class="btn-action btn-confirm" data-action="visszaigasolva">
                                    ‚úì Visszaigazol
                                </button>
                                <button class="btn-action btn-delete" data-action="torolve">
                                    ‚úï T√∂r√∂l
                                </button>
                            {% elif rendeles.allapot == 'visszaigasolva' %}
                                <button class="btn-action btn-done" data-action="atadva">
                                    ‚úì‚úì K√©sz
                                </button>
                                <button class="btn-action btn-delete" data-action="torolve">
                                    ‚úï T√∂r√∂l
                                </button>
                            {% elif rendeles.allapot == 'atadva' %}
                                <button class="btn-action btn-undo" data-action="visszaigasolva">
                                    ‚Ü∂ Visszavon
                                </button>
                                <button class="btn-action btn-archive" data-action="archive">
                                    üì¶ Archiv√°l
                                </button>
                            {% elif rendeles.allapot == 'torolve' %}
                                <button class="btn-action btn-undo" data-action="visszaigasolva">
                                    ‚Ü∂ Vissza√°ll√≠t
                                </button>
                                <button class="btn-action btn-archive" data-action="archive">
                                    üì¶ Archiv√°l
                                </button>
                            {% elif rendeles.allapot == 'visszavonva' %}
                                <button class="btn-action btn-undo" data-action="visszaigasolva">
                                    ‚Ü∂ Vissza√°ll√≠t
                                </button>
                                <button class="btn-action btn-archive" data-action="archive">
                                    üì¶ Archiv√°l
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-orders">
                        <p>üì≠ Nincsenek akt√≠v rendel√©sek</p>
                    </div>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Rendel√©s r√©szletei</h3>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <!-- Archive Confirmation Modal -->
    <div class="modal" id="archiveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Archiv√°l√°s meger≈ës√≠t√©se</h3>
                <button class="modal-close" id="archiveModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <p>Biztosan archiv√°lni szeretn√© az √∂sszes k√©sz rendel√©st?</p>
                <p class="modal-warning">Ez a m≈±velet nem vonhat√≥ vissza!</p>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="archiveCancelBtn">M√©gse</button>
                    <button class="btn btn-danger" id="archiveConfirmBtn">Archiv√°l√°s</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio element for notification sound (inline base64 due to static file handling issue) -->
    <audio id="notificationSound" preload="auto">
        <source src="data:audio/wav;base64,EOF
echo -n "$(cat /tmp/notification_base64.txt)" >> /tmp/dashboard_footer.html
cat >> /tmp/dashboard_footer.html << 'EOF'
" type="audio/wav">
    </audio>

    <script>
/**
 * B√ºf√© Admin Dashboard - Real-time Order Management (inline due to static file handling issue)
 */

// Configuration
const WS_PROTOCOL = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
const WS_HOST = window.location.host;
const WS_URL = `${WS_PROTOCOL}//${WS_HOST}/ws/bufe/orders/`;

// State
let ws = null;
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 5;
let reconnectTimeout = null;
let orders = new Map();
let currentFilter = 'all';
let lastOrderCount = 0;

// DOM Elements
const ordersGrid = document.getElementById('ordersGrid');
const orderCount = document.getElementById('orderCount');
const connectionStatus = document.getElementById('connectionStatus');
const refreshBtn = document.getElementById('refreshBtn');
const archiveAllBtn = document.getElementById('archiveAllBtn');
const orderModal = document.getElementById('orderModal');
const archiveModal = document.getElementById('archiveModal');
const modalClose = document.getElementById('modalClose');
const archiveModalClose = document.getElementById('archiveModalClose');
const archiveCancelBtn = document.getElementById('archiveCancelBtn');
const archiveConfirmBtn = document.getElementById('archiveConfirmBtn');
const filterTabs = document.querySelectorAll('.filter-tab');
const notificationSound = document.getElementById('notificationSound');

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    initWebSocket();
    loadOrders();
    setupEventListeners();
    setupFilters();
});

// WebSocket Functions
function initWebSocket() {
    try {
        ws = new WebSocket(WS_URL);
        
        ws.onopen = () => {
            console.log('WebSocket connected');
            updateConnectionStatus('connected');
            reconnectAttempts = 0;
        };
        
        ws.onmessage = (event) => {
            handleWebSocketMessage(JSON.parse(event.data));
        };
        
        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            updateConnectionStatus('error');
        };
        
        ws.onclose = () => {
            console.log('WebSocket disconnected');
            updateConnectionStatus('disconnected');
            scheduleReconnect();
        };
    } catch (error) {
        console.error('Failed to initialize WebSocket:', error);
        updateConnectionStatus('error');
    }
}

function handleWebSocketMessage(data) {
    console.log('WebSocket message:', data);
    
    switch (data.type) {
        case 'order_update':
            handleOrderUpdate(data.action, data.order);
            break;
        case 'pong':
            // Heartbeat response
            break;
        case 'error':
            console.error('WebSocket error:', data.message);
            break;
    }
}

function handleOrderUpdate(action, order) {
    switch (action) {
        case 'new':
            addNewOrder(order);
            playNotificationSound();
            flashOrder(order.id);
            break;
        case 'update':
            updateOrder(order);
            break;
        case 'archive':
            removeOrder(order.id);
            break;
        case 'archive_all':
            loadOrders(); // Reload all orders
            break;
    }
    updateOrderCount();
}

function scheduleReconnect() {
    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
        reconnectAttempts++;
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
        console.log(`Reconnecting in ${delay}ms (attempt ${reconnectAttempts})`);
        
        reconnectTimeout = setTimeout(() => {
            initWebSocket();
        }, delay);
    } else {
        console.error('Max reconnection attempts reached');
        updateConnectionStatus('failed');
    }
}

function updateConnectionStatus(status) {
    const statusDot = connectionStatus.querySelector('.status-dot');
    const statusText = connectionStatus.querySelector('.status-text');
    
    connectionStatus.className = 'connection-status';
    
    switch (status) {
        case 'connected':
            connectionStatus.classList.add('connected');
            statusText.textContent = 'Kapcsol√≥dva';
            break;
        case 'disconnected':
            connectionStatus.classList.add('disconnected');
            statusText.textContent = 'Kapcsolat megszakadt';
            break;
        case 'error':
            connectionStatus.classList.add('error');
            statusText.textContent = 'Kapcsol√≥d√°si hiba';
            break;
        case 'failed':
            connectionStatus.classList.add('error');
            statusText.textContent = 'Sikertelen kapcsol√≥d√°s';
            break;
    }
}

// API Functions
async function loadOrders() {
    try {
        const response = await fetch('/bufe/admin/api/orders/');
        const data = await response.json();
        
        if (data.success) {
            orders.clear();
            data.orders.forEach(order => {
                orders.set(order.id, order);
            });
            renderOrders();
            updateOrderCount();
        }
    } catch (error) {
        console.error('Failed to load orders:', error);
    }
}

async function updateOrderStatus(orderId, status) {
    try {
        const response = await fetch('/bufe/admin/api/update-order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                order_id: orderId,
                status: status
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            updateOrder(data.order);
        } else {
            alert('Hiba: ' + data.error);
        }
    } catch (error) {
        console.error('Failed to update order:', error);
        alert('Hiba t√∂rt√©nt a rendel√©s friss√≠t√©se sor√°n.');
    }
}

async function archiveOrder(orderId) {
    try {
        const response = await fetch('/bufe/admin/api/archive-order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                order_id: orderId
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            removeOrder(orderId);
        } else {
            alert('Hiba: ' + data.error);
        }
    } catch (error) {
        console.error('Failed to archive order:', error);
        alert('Hiba t√∂rt√©nt a rendel√©s archiv√°l√°sa sor√°n.');
    }
}

async function archiveAllDone() {
    try {
        const response = await fetch('/bufe/admin/api/archive-all-done/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            alert(`${data.archived_count} rendel√©s archiv√°lva.`);
            loadOrders();
        } else {
            alert('Hiba: ' + data.error);
        }
    } catch (error) {
        console.error('Failed to archive all orders:', error);
        alert('Hiba t√∂rt√©nt a rendel√©sek archiv√°l√°sa sor√°n.');
    }
}

// UI Functions
function renderOrders() {
    const filteredOrders = Array.from(orders.values()).filter(order => {
        if (currentFilter === 'all') return true;
        return order.allapot === currentFilter;
    });
    
    if (filteredOrders.length === 0) {
        ordersGrid.innerHTML = '<div class="no-orders"><p>üì≠ Nincsenek rendel√©sek</p></div>';
        return;
    }
    
    ordersGrid.innerHTML = filteredOrders.map(order => createOrderCard(order)).join('');
    
    // Attach event listeners
    document.querySelectorAll('.order-card').forEach(card => {
        let tapCount = 0;
        let tapTimer = null;
        
        card.addEventListener('click', (e) => {
            if (e.target.closest('.btn-action')) return;
            
            tapCount++;
            
            if (tapCount === 1) {
                tapTimer = setTimeout(() => {
                    // Single tap - show details
                    showOrderDetails(card.dataset.orderId);
                    tapCount = 0;
                }, 300);
            } else if (tapCount === 2) {
                // Double tap - mark as next status
                clearTimeout(tapTimer);
                const orderId = parseInt(card.dataset.orderId);
                const order = orders.get(orderId);
                
                if (order) {
                    // Double tap transitions:
                    // leadva -> visszaigasolva
                    // visszaigasolva -> atadva
                    if (order.allapot === 'leadva') {
                        updateOrderStatus(orderId, 'visszaigasolva');
                    } else if (order.allapot === 'visszaigasolva') {
                        updateOrderStatus(orderId, 'atadva');
                    }
                }
                
                tapCount = 0;
            }
        });
    });
    
    // Attach button event listeners
    document.querySelectorAll('.btn-action').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = e.target.closest('.order-card');
            const orderId = parseInt(card.dataset.orderId);
            const action = e.target.dataset.action;
            
            if (action === 'archive') {
                archiveOrder(orderId);
            } else {
                updateOrderStatus(orderId, action);
            }
        });
    });
}

function createOrderCard(order) {
    const statusClass = `status-${order.allapot}`;
    const itemsPreview = order.items.slice(0, 3).map(item => 
        `<span class="item-badge">${item.mennyiseg}x ${item.termek_nev}</span>`
    ).join('');
    const moreItems = order.items.length > 3 ? 
        `<span class="item-badge">+${order.items.length - 3} tov√°bbi</span>` : '';
    
    let actions = '';
    if (order.allapot === 'leadva') {
        actions = `
            <button class="btn-action btn-confirm" data-action="visszaigasolva">‚úì Visszaigazol</button>
            <button class="btn-action btn-delete" data-action="torolve">‚úï T√∂r√∂l</button>
        `;
    } else if (order.allapot === 'visszaigasolva') {
        actions = `
            <button class="btn-action btn-done" data-action="atadva">‚úì‚úì K√©sz</button>
            <button class="btn-action btn-delete" data-action="torolve">‚úï T√∂r√∂l</button>
        `;
    } else if (order.allapot === 'atadva') {
        actions = `
            <button class="btn-action btn-undo" data-action="visszaigasolva">‚Ü∂ Visszavon</button>
            <button class="btn-action btn-archive" data-action="archive">üì¶ Archiv√°l</button>
        `;
    } else if (order.allapot === 'torolve') {
        actions = `
            <button class="btn-action btn-undo" data-action="visszaigasolva">‚Ü∂ Vissza√°ll√≠t</button>
            <button class="btn-action btn-archive" data-action="archive">üì¶ Archiv√°l</button>
        `;
    } else if (order.allapot === 'visszavonva') {
        actions = `
            <button class="btn-action btn-undo" data-action="visszaigasolva">‚Ü∂ Vissza√°ll√≠t</button>
            <button class="btn-action btn-archive" data-action="archive">üì¶ Archiv√°l</button>
        `;
    }
    
    return `
        <div class="order-card" data-order-id="${order.id}" data-status="${order.allapot}">
            <div class="order-header">
                <div class="order-number">#${order.id}</div>
                <div class="order-status ${statusClass}">${order.allapot_display}</div>
            </div>
            <div class="order-body">
                <div class="order-user"><strong>${order.user.full_name}</strong></div>
                <div class="order-time">${formatDateTime(order.leadva)}</div>
                <div class="order-items-preview">${itemsPreview}${moreItems}</div>
                <div class="order-total">${order.vegosszeg} Ft</div>
                ${order.megjegyzes ? `<div class="order-note">üí¨ ${order.megjegyzes}</div>` : ''}
            </div>
            <div class="order-actions">${actions}</div>
        </div>
    `;
}

function addNewOrder(order) {
    orders.set(order.id, order);
    renderOrders();
}

function updateOrder(order) {
    orders.set(order.id, order);
    renderOrders();
}

function removeOrder(orderId) {
    orders.delete(orderId);
    renderOrders();
    updateOrderCount();
}

function flashOrder(orderId) {
    setTimeout(() => {
        const card = document.querySelector(`[data-order-id="${orderId}"]`);
        if (card) {
            card.classList.add('flash');
            setTimeout(() => card.classList.remove('flash'), 2000);
        }
    }, 100);
}

function showOrderDetails(orderId) {
    const order = orders.get(parseInt(orderId));
    if (!order) return;
    
    const itemsList = order.items.map(item => `
        <tr>
            <td>${item.termek_nev}</td>
            <td class="text-center">${item.mennyiseg} db</td>
            <td class="text-right">${item.termek_ar} Ft</td>
            <td class="text-right">${item.osszeg} Ft</td>
        </tr>
    `).join('');
    
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = `
        <div class="order-detail">
            <div class="detail-row">
                <span class="detail-label">Rendel√©ssz√°m:</span>
                <span class="detail-value">#${order.id}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">V√°s√°rl√≥:</span>
                <span class="detail-value">${order.user.full_name}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Email:</span>
                <span class="detail-value">${order.user.email}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Leadva:</span>
                <span class="detail-value">${formatDateTime(order.leadva)}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">√Ållapot:</span>
                <span class="detail-value status-${order.allapot}">${order.allapot_display}</span>
            </div>
            ${order.megjegyzes ? `
            <div class="detail-row">
                <span class="detail-label">Megjegyz√©s:</span>
                <span class="detail-value">${order.megjegyzes}</span>
            </div>
            ` : ''}
            <h4>T√©telek:</h4>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Term√©k</th>
                        <th class="text-center">Mennyis√©g</th>
                        <th class="text-right">Egys√©g√°r</th>
                        <th class="text-right">√ñsszeg</th>
                    </tr>
                </thead>
                <tbody>${itemsList}</tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-right"><strong>V√©g√∂sszeg:</strong></td>
                        <td class="text-right"><strong>${order.vegosszeg} Ft</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;
    
    orderModal.style.display = 'flex';
}

function updateOrderCount() {
    const count = orders.size;
    orderCount.textContent = `${count} rendel√©s`;
    
    // Update document title if count changed
    if (count !== lastOrderCount) {
        document.title = `(${count}) B√ºf√© Admin - Rendel√©sek`;
        lastOrderCount = count;
    }
}

function setupFilters() {
    filterTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            filterTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            currentFilter = tab.dataset.filter;
            renderOrders();
        });
    });
}

function setupEventListeners() {
    refreshBtn.addEventListener('click', () => {
        loadOrders();
    });
    
    archiveAllBtn.addEventListener('click', () => {
        archiveModal.style.display = 'flex';
    });
    
    modalClose.addEventListener('click', () => {
        orderModal.style.display = 'none';
    });
    
    archiveModalClose.addEventListener('click', () => {
        archiveModal.style.display = 'none';
    });
    
    archiveCancelBtn.addEventListener('click', () => {
        archiveModal.style.display = 'none';
    });
    
    archiveConfirmBtn.addEventListener('click', () => {
        archiveModal.style.display = 'none';
        archiveAllDone();
    });
    
    // Close modals on outside click
    window.addEventListener('click', (e) => {
        if (e.target === orderModal) {
            orderModal.style.display = 'none';
        }
        if (e.target === archiveModal) {
            archiveModal.style.display = 'none';
        }
    });
}

// Notification Sound
function playNotificationSound() {
    try {
        // Reset audio to beginning if it's already playing
        notificationSound.currentTime = 0;
        
        // Try to play the audio file
        const playPromise = notificationSound.play();
        
        if (playPromise !== undefined) {
            playPromise.catch((error) => {
                console.warn('Audio playback failed:', error);
                // Fallback to Web Audio API if playback fails
                playBeep();
            });
        }
    } catch (error) {
        console.error('Error playing notification sound:', error);
        // Fallback to Web Audio API
        playBeep();
    }
}

function playBeep() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (error) {
        console.error('Failed to play notification sound:', error);
    }
}

// Utility Functions
function formatDateTime(dateString) {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}.${month}.${day} ${hours}:${minutes}`;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Get CSRF token - try multiple possible names
function getCSRFToken() {
    // Try to get from cookie
    let token = getCookie('csrftoken');
    
    // If not found, try to get from hidden input
    if (!token) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            token = csrfInput.value;
        }
    }
    
    // If still not found, try meta tag
    if (!token) {
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        if (csrfMeta) {
            token = csrfMeta.content;
        }
    }
    
    return token;
}

// Heartbeat to keep connection alive
setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'ping' }));
    }
}, 30000); // Every 30 seconds
    </script>
</body>
</html>
